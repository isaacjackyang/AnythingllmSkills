<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Launch UI</title>
    <style>
      :root {
        --bg-1: #0f172a;
        --bg-2: #1e293b;
        --card: rgba(15, 23, 42, 0.75);
        --text: #e2e8f0;
        --primary: #38bdf8;
        --accent: #f472b6;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at top right, #334155, var(--bg-1) 45%),
          linear-gradient(135deg, var(--bg-1), var(--bg-2));
      }

      .panel {
        width: 100vw;
        height: 100vh;
        padding: 1rem;
        background: var(--card);
        border: 1px solid rgba(148, 163, 184, 0.2);
        backdrop-filter: blur(10px);
        display: grid;
        grid-template-rows: 60fr 20fr 20fr;
        gap: 1rem;
      }

      .dashboard h1 {
        margin: 0;
        font-size: clamp(1.1rem, 2.4vw, 1.5rem);
      }

      .dashboard p {
        line-height: 1.5;
        color: #cbd5e1;
        margin: 0.55rem 0 0.8rem;
        font-size: 0.9rem;
      }

      .start-btn {
        border: 0;
        border-radius: 999px;
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        padding: 0.65rem 1.35rem;
        cursor: pointer;
        color: #0f172a;
        background: linear-gradient(135deg, var(--primary), #22d3ee);
        box-shadow: 0 12px 22px rgba(34, 211, 238, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .start-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 26px rgba(34, 211, 238, 0.45);
      }

      .stage {
        position: relative;
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 20px;
        background: rgba(15, 23, 42, 0.45);
        overflow: hidden;
      }

      .stage canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .stage-controls {
        position: absolute;
        top: 0.65rem;
        left: 0.65rem;
        right: 0.65rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        z-index: 2;
      }

      .upload-label {
        border: 1px solid rgba(125, 211, 252, 0.45);
        background: rgba(15, 23, 42, 0.72);
        border-radius: 8px;
        padding: 0.32rem 0.55rem;
        font-size: 0.74rem;
        color: #bfdbfe;
        cursor: pointer;
      }

      .upload-label input {
        display: none;
      }

      .motion-btn {
        border: 1px solid rgba(125, 211, 252, 0.45);
        background: rgba(15, 23, 42, 0.72);
        color: #bae6fd;
        border-radius: 8px;
        padding: 0.32rem 0.55rem;
        font-size: 0.74rem;
        cursor: pointer;
      }

      .status {
        margin-top: 0.6rem;
        font-size: 0.95rem;
        color: #a5f3fc;
        min-height: 1.2em;
      }

      .dashboard,
      .console {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 16px;
        background: rgba(15, 23, 42, 0.6);
        padding: 0.8rem;
        overflow: hidden;
      }

      .monitor {
        margin-top: 0.6rem;
        display: grid;
        gap: 0.8rem;
      }

      .pane {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.6);
        padding: 0.75rem;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.55rem;
      }

      .metric {
        border-radius: 10px;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.15);
        padding: 0.55rem 0.65rem;
      }

      .metric .label {
        font-size: 0.75rem;
        color: #94a3b8;
      }

      .metric .value {
        margin-top: 0.2rem;
        font-size: 0.95rem;
        font-weight: 700;
        color: #e2e8f0;
      }

      .control-row {
        margin-top: 0.7rem;
        display: flex;
        gap: 0.55rem;
      }

      .ctrl-btn {
        border: 1px solid rgba(125, 211, 252, 0.45);
        background: rgba(15, 23, 42, 0.8);
        color: #bae6fd;
        border-radius: 8px;
        padding: 0.45rem 0.72rem;
        font-size: 0.78rem;
        cursor: pointer;
      }

      .ctrl-btn.stop {
        border-color: rgba(251, 113, 133, 0.55);
        color: #fecdd3;
      }

      .console-log {
        margin: 0;
        height: 100%;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 0.76rem;
        line-height: 1.45;
        color: #bfdbfe;
        white-space: pre-wrap;
      }

      .console h2 {
        margin: 0 0 0.5rem;
        font-size: 0.95rem;
      }

      @media (orientation: landscape) {
        .panel {
          grid-template-columns: 1fr 1fr;
          grid-template-rows: 1fr;
        }

        .stage { grid-row: 1; grid-column: 1; }
        .dashboard { grid-row: 1; grid-column: 2; }

        .dashboard {
          display: grid;
          grid-template-rows: 60fr 40fr;
          gap: 0.8rem;
        }

        .dashboard-main,
        .console-landscape {
          border: 1px solid rgba(148, 163, 184, 0.2);
          border-radius: 14px;
          background: rgba(15, 23, 42, 0.45);
          padding: 0.75rem;
          overflow: hidden;
        }

        .console { display: none; }
        .console-landscape { display: block; }
      }

      @media (orientation: portrait) {
        .dashboard-main { display: block; }
        .console-landscape { display: none; }
      }
    </style>
  </head>
  <body>
    <main class="panel">
      <section class="stage" aria-label="照片人物 2D 動作模擬區">
        <div class="stage-controls">
          <label class="upload-label">上傳照片
            <input id="photoInput" type="file" accept="image/*" />
          </label>
          <button id="motionToggle" class="motion-btn" type="button">暫停動作</button>
        </div>
        <canvas id="motionCanvas" width="960" height="640" role="img" aria-label="照片人物 2D 骨架動作模擬"></canvas>
      </section>

      <section class="dashboard">
        <div class="dashboard-main">
          <h1>Agent 啟動面板</h1>
          <p>歡迎使用 Agent 控制台。按下按鈕後，系統會初始化流程並開始執行任務。</p>
          <button id="startAgent" class="start-btn" type="button">Start Agent</button>
          <p id="status" class="status" aria-live="polite"></p>

          <section class="monitor" aria-label="Agent dashboard">
            <section id="dashboardPane" class="pane" role="region" aria-label="dashboard">
            <div class="metric-grid">
              <article class="metric">
                <div class="label">助手狀態</div>
                <div id="assistantStatus" class="value">Idle</div>
              </article>
              <article class="metric">
                <div class="label">執行狀態</div>
                <div id="executionStatus" class="value">未執行</div>
              </article>
              <article class="metric">
                <div class="label">進度</div>
                <div id="taskProgress" class="value">0%</div>
              </article>
              <article class="metric">
                <div class="label">最後更新</div>
                <div id="lastUpdated" class="value">--:--:--</div>
              </article>
            </div>
            <div class="control-row">
              <button id="pauseAgent" class="ctrl-btn" type="button">暫停任務</button>
              <button id="resumeAgent" class="ctrl-btn" type="button">恢復任務</button>
              <button id="stopAgent" class="ctrl-btn stop" type="button">停止 Agent</button>
              <button id="clearConsole" class="ctrl-btn" type="button">清除 Console</button>
            </div>
          </section>
          </section>
        </div>

        <section class="console-landscape" aria-label="console">
          <h2>Console</h2>
          <pre id="consoleLogLandscape" class="console-log">[system] 等待啟動指令...</pre>
        </section>
      </section>

      <section class="console" aria-label="console">
        <h2>Console</h2>
        <section id="consolePane" class="pane" role="region" aria-label="console">
            <pre id="consoleLog" class="console-log">[system] 等待啟動指令...</pre>
        </section>
      </section>
    </main>

    <script>
      const button = document.getElementById('startAgent');
      const status = document.getElementById('status');
      const assistantStatus = document.getElementById('assistantStatus');
      const executionStatus = document.getElementById('executionStatus');
      const taskProgress = document.getElementById('taskProgress');
      const lastUpdated = document.getElementById('lastUpdated');
      const consoleLog = document.getElementById('consoleLog');
      const consoleLogLandscape = document.getElementById('consoleLogLandscape');
      const pauseBtn = document.getElementById('pauseAgent');
      const resumeBtn = document.getElementById('resumeAgent');
      const stopBtn = document.getElementById('stopAgent');
      const clearConsoleBtn = document.getElementById('clearConsole');
      const photoInput = document.getElementById('photoInput');
      const motionToggle = document.getElementById('motionToggle');
      const motionCanvas = document.getElementById('motionCanvas');
      const motionCtx = motionCanvas.getContext('2d');

      let runningMotion = true;
      let backgroundImage = null;

      const basePose = {
        head: { x: 460, y: 160 },
        neck: { x: 460, y: 210 },
        shoulderL: { x: 415, y: 235 },
        shoulderR: { x: 505, y: 235 },
        elbowL: { x: 390, y: 300 },
        elbowR: { x: 540, y: 300 },
        handL: { x: 368, y: 360 },
        handR: { x: 580, y: 360 },
        hip: { x: 460, y: 365 },
        kneeL: { x: 430, y: 470 },
        kneeR: { x: 490, y: 470 },
        footL: { x: 410, y: 590 },
        footR: { x: 510, y: 590 },
      };

      const drawBone = (a, b, width = 5, color = '#38bdf8') => {
        motionCtx.beginPath();
        motionCtx.moveTo(a.x, a.y);
        motionCtx.lineTo(b.x, b.y);
        motionCtx.lineWidth = width;
        motionCtx.strokeStyle = color;
        motionCtx.stroke();
      };

      const drawJoint = (joint, color = '#e2e8f0') => {
        motionCtx.beginPath();
        motionCtx.arc(joint.x, joint.y, 5, 0, Math.PI * 2);
        motionCtx.fillStyle = color;
        motionCtx.fill();
      };

      const drawSkeleton = (pose) => {
        drawBone(pose.head, pose.neck, 3);
        drawBone(pose.neck, pose.shoulderL);
        drawBone(pose.neck, pose.shoulderR);
        drawBone(pose.shoulderL, pose.elbowL);
        drawBone(pose.elbowL, pose.handL);
        drawBone(pose.shoulderR, pose.elbowR);
        drawBone(pose.elbowR, pose.handR);
        drawBone(pose.neck, pose.hip, 6);
        drawBone(pose.hip, pose.kneeL);
        drawBone(pose.kneeL, pose.footL);
        drawBone(pose.hip, pose.kneeR);
        drawBone(pose.kneeR, pose.footR);
        Object.values(pose).forEach((joint) => drawJoint(joint));
      };

      const loadPhoto = (file) => new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = URL.createObjectURL(file);
      });

      photoInput.addEventListener('change', async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        try {
          backgroundImage = await loadPhoto(file);
          appendLog(`[stage] 已載入照片：${file.name}`);
        } catch (error) {
          appendLog(`[error] 照片載入失敗：${error.message}`);
        }
      });

      motionToggle.addEventListener('click', () => {
        runningMotion = !runningMotion;
        motionToggle.textContent = runningMotion ? '暫停動作' : '繼續動作';
        if (runningMotion) {
          requestAnimationFrame(renderMotion);
        }
      });

      const renderMotion = (timestamp) => {
        motionCtx.clearRect(0, 0, motionCanvas.width, motionCanvas.height);

        if (backgroundImage) {
          const ratio = Math.min(motionCanvas.width / backgroundImage.width, motionCanvas.height / backgroundImage.height);
          const drawWidth = backgroundImage.width * ratio;
          const drawHeight = backgroundImage.height * ratio;
          const x = (motionCanvas.width - drawWidth) / 2;
          const y = (motionCanvas.height - drawHeight) / 2;
          motionCtx.drawImage(backgroundImage, x, y, drawWidth, drawHeight);
        } else {
          motionCtx.fillStyle = '#0f172a';
          motionCtx.fillRect(0, 0, motionCanvas.width, motionCanvas.height);
          motionCtx.fillStyle = '#94a3b8';
          motionCtx.font = '600 20px "Noto Sans TC", sans-serif';
          motionCtx.fillText('上傳照片後，可在左側看到 2D 骨架揮手模擬。', 170, 56);
        }

        const phase = timestamp * 0.004;
        const pose = structuredClone(basePose);
        pose.elbowR.y = basePose.elbowR.y - (Math.sin(phase) * 52);
        pose.handR.y = basePose.handR.y - (Math.sin(phase) * 88);
        pose.handR.x = basePose.handR.x + (Math.cos(phase) * 22);
        drawSkeleton(pose);

        if (runningMotion) {
          requestAnimationFrame(renderMotion);
        }
      };

      requestAnimationFrame(renderMotion);

      const toLocalTime = (iso) => {
        if (!iso) return '--:--:--';
        return new Date(iso).toLocaleTimeString('zh-Hant-TW', { hour12: false });
      };

      const appendLog = (text) => {
        [consoleLog, consoleLogLandscape].forEach((targetLog) => {
          targetLog.textContent += `\n${text}`;
          targetLog.scrollTop = targetLog.scrollHeight;
        });
      };

      const applyControlState = (data) => {
        assistantStatus.textContent = data.assistant_status;
        executionStatus.textContent = data.execution_status;
        taskProgress.textContent = `${data.task_progress}%`;
        lastUpdated.textContent = toLocalTime(data.last_updated_at);

        button.disabled = !data.can.start;
        pauseBtn.disabled = !data.can.pause;
        resumeBtn.disabled = !data.can.resume;
        stopBtn.disabled = !data.can.stop;
      };

      const refreshState = async () => {
        const response = await fetch('/api/agent/control');
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || '讀取 Agent 狀態失敗');
        }
        applyControlState(payload.data);
      };

      const sendControl = async (action) => {
        const response = await fetch('/api/agent/control', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action }),
        });
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || `${action} 失敗`);
        }
        applyControlState(payload.data);
        return payload.data;
      };

      button.addEventListener('click', async () => {
        try {
          status.textContent = 'Agent 啟動中...';
          await sendControl('start');
          status.textContent = 'Agent 已啟動，秘書待命中。';
          appendLog('[control] 使用者啟動 Agent');
        } catch (error) {
          status.textContent = `啟動失敗：${error.message}`;
          appendLog(`[error] 啟動失敗：${error.message}`);
        }
      });

      pauseBtn.addEventListener('click', async () => {
        try {
          await sendControl('pause');
          status.textContent = 'Agent 已暫停。';
          appendLog('[control] 使用者暫停任務');
        } catch (error) {
          status.textContent = `暫停失敗：${error.message}`;
          appendLog(`[error] 暫停失敗：${error.message}`);
        }
      });

      resumeBtn.addEventListener('click', async () => {
        try {
          await sendControl('resume');
          status.textContent = 'Agent 已恢復執行。';
          appendLog('[control] 使用者恢復任務');
        } catch (error) {
          status.textContent = `恢復失敗：${error.message}`;
          appendLog(`[error] 恢復失敗：${error.message}`);
        }
      });

      stopBtn.addEventListener('click', async () => {
        try {
          await sendControl('stop');
          status.textContent = 'Agent 已停止。';
          appendLog('[control] 使用者停止 Agent');
        } catch (error) {
          status.textContent = `停止失敗：${error.message}`;
          appendLog(`[error] 停止失敗：${error.message}`);
        }
      });

      clearConsoleBtn.addEventListener('click', () => {
        [consoleLog, consoleLogLandscape].forEach((targetLog) => {
          targetLog.textContent = '[system] console 已清空';
        });
        lastUpdated.textContent = toLocalTime(new Date().toISOString());
      });

      refreshState()
        .then(() => appendLog('[system] 已連線 Gateway 控制 API'))
        .catch((error) => {
          status.textContent = `無法連線控制 API：${error.message}`;
          appendLog(`[error] 無法連線控制 API：${error.message}`);
        });
    </script>
  </body>
</html>
