<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Launch UI</title>
    <style>
      :root {
        --bg-1: #0f172a;
        --bg-2: #1e293b;
        --card: rgba(15, 23, 42, 0.75);
        --text: #e2e8f0;
        --primary: #38bdf8;
        --accent: #f472b6;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at top right, #334155, var(--bg-1) 45%),
          linear-gradient(135deg, var(--bg-1), var(--bg-2));
      }

      .panel {
        width: 100vw;
        height: 100vh;
        padding: 1rem;
        background: var(--card);
        border: 1px solid rgba(148, 163, 184, 0.2);
        backdrop-filter: blur(10px);
        display: grid;
        grid-template-rows: 60fr 20fr 20fr;
        gap: 1rem;
      }

      .dashboard h1 {
        margin: 0;
        font-size: clamp(1.1rem, 2.4vw, 1.5rem);
      }

      .dashboard p {
        line-height: 1.5;
        color: #cbd5e1;
        margin: 0.55rem 0 0.8rem;
        font-size: 0.9rem;
      }

      .start-btn {
        border: 0;
        border-radius: 999px;
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        padding: 0.65rem 1.35rem;
        cursor: pointer;
        color: #0f172a;
        background: linear-gradient(135deg, var(--primary), #22d3ee);
        box-shadow: 0 12px 22px rgba(34, 211, 238, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .start-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 26px rgba(34, 211, 238, 0.45);
      }

      .stage {
        position: relative;
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 20px;
        background: rgba(15, 23, 42, 0.45);
        overflow: hidden;
      }

      .stage canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .stage-controls {
        position: absolute;
        top: 0.65rem;
        left: 0.65rem;
        right: 0.65rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        z-index: 2;
      }

      .upload-label {
        border: 1px solid rgba(125, 211, 252, 0.45);
        background: rgba(15, 23, 42, 0.72);
        border-radius: 8px;
        padding: 0.32rem 0.55rem;
        font-size: 0.74rem;
        color: #bfdbfe;
        cursor: pointer;
      }

      .upload-label input {
        display: none;
      }

      .motion-btn {
        border: 1px solid rgba(125, 211, 252, 0.45);
        background: rgba(15, 23, 42, 0.72);
        color: #bae6fd;
        border-radius: 8px;
        padding: 0.32rem 0.55rem;
        font-size: 0.74rem;
        cursor: pointer;
      }

      .status {
        margin-top: 0.6rem;
        font-size: 0.95rem;
        color: #a5f3fc;
        min-height: 1.2em;
      }

      .dashboard,
      .console {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 16px;
        background: rgba(15, 23, 42, 0.6);
        padding: 0.8rem;
        overflow: hidden;
      }

      .monitor {
        margin-top: 0.6rem;
        display: grid;
        gap: 0.8rem;
      }

      .pane {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.6);
        padding: 0.75rem;
      }

      .metric-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.55rem;
      }

      .metric {
        border-radius: 10px;
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.15);
        padding: 0.55rem 0.65rem;
      }

      .metric .label {
        font-size: 0.75rem;
        color: #94a3b8;
      }

      .metric .value {
        margin-top: 0.2rem;
        font-size: 0.95rem;
        font-weight: 700;
        color: #e2e8f0;
      }

      .control-row {
        margin-top: 0.7rem;
        display: flex;
        gap: 0.55rem;
        flex-wrap: wrap;
      }

      .ctrl-btn {
        border: 1px solid rgba(125, 211, 252, 0.45);
        background: rgba(15, 23, 42, 0.8);
        color: #bae6fd;
        border-radius: 8px;
        padding: 0.45rem 0.72rem;
        font-size: 0.78rem;
        cursor: pointer;
      }

      .ctrl-btn.stop {
        border-color: rgba(251, 113, 133, 0.55);
        color: #fecdd3;
      }

      .console-log {
        margin: 0;
        height: 100%;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 0.76rem;
        line-height: 1.45;
        color: #bfdbfe;
        white-space: pre-wrap;
      }

      .console h2 {
        margin: 0 0 0.5rem;
        font-size: 0.95rem;
      }

      .flow-card {
        margin-top: 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.56);
        padding: 0.65rem;
      }

      .flow-card h3 {
        margin: 0 0 0.45rem;
        font-size: 0.82rem;
        color: #bfdbfe;
        letter-spacing: 0.02em;
      }

      .flow-help {
        margin: 0 0 0.55rem;
        font-size: 0.73rem;
        color: #94a3b8;
      }

      .flow-svg {
        width: 100%;
        height: 260px;
        display: block;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.85);
      }

      .flow-legend {
        margin-top: 0.55rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        font-size: 0.7rem;
        color: #cbd5e1;
      }

      .chip {
        border-radius: 999px;
        padding: 0.14rem 0.45rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(30, 41, 59, 0.6);
      }

      @media (orientation: landscape) {
        .panel {
          grid-template-columns: 1fr 1fr;
          grid-template-rows: 1fr;
        }

        .stage { grid-row: 1; grid-column: 1; }
        .dashboard { grid-row: 1; grid-column: 2; }

        .dashboard {
          display: grid;
          grid-template-rows: 60fr 40fr;
          gap: 0.8rem;
        }

        .dashboard-main,
        .console-landscape {
          border: 1px solid rgba(148, 163, 184, 0.2);
          border-radius: 14px;
          background: rgba(15, 23, 42, 0.45);
          padding: 0.75rem;
          overflow: hidden;
        }

        .console { display: none; }
        .console-landscape { display: block; }
      }

      @media (orientation: portrait) {
        .dashboard-main { display: block; }
        .console-landscape { display: none; }
      }
    </style>
  </head>
  <body>
    <main class="panel">
      <section class="stage" aria-label="ç…§ç‰‡äººç‰© 2D å‹•ä½œæ¨¡æ“¬å€">
        <div class="stage-controls">
          <label class="upload-label">ä¸Šå‚³ç…§ç‰‡
            <input id="photoInput" type="file" accept="image/*" />
          </label>
          <button id="motionToggle" class="motion-btn" type="button">æš«åœå‹•ä½œ</button>
          <button id="pauseAndClearStage" class="motion-btn" type="button">æš«åœä¸¦æ¸…ç•«é¢</button>
        </div>
        <canvas id="motionCanvas" width="960" height="640" role="img" aria-label="ç…§ç‰‡äººç‰© 2D éª¨æ¶å‹•ä½œæ¨¡æ“¬"></canvas>
      </section>

      <section class="dashboard">
        <div class="dashboard-main">
          <h1>Agent å•Ÿå‹•é¢æ¿</h1>
          <p>æ­¡è¿ä½¿ç”¨ Agent æ§åˆ¶å°ã€‚æŒ‰ä¸‹æŒ‰éˆ•å¾Œï¼Œç³»çµ±æœƒåˆå§‹åŒ–æµç¨‹ä¸¦é–‹å§‹åŸ·è¡Œä»»å‹™ã€‚</p>
          <button id="startAgent" class="start-btn" type="button">Start Agent</button>
          <p id="status" class="status" aria-live="polite"></p>

          <section class="monitor" aria-label="Agent dashboard">
            <section id="dashboardPane" class="pane" role="region" aria-label="dashboard">
            <div class="metric-grid">
              <article class="metric">
                <div class="label">åŠ©æ‰‹ç‹€æ…‹</div>
                <div id="assistantStatus" class="value">Idle</div>
              </article>
              <article class="metric">
                <div class="label">åŸ·è¡Œç‹€æ…‹</div>
                <div id="executionStatus" class="value">æœªåŸ·è¡Œ</div>
              </article>
              <article class="metric">
                <div class="label">é€²åº¦</div>
                <div id="taskProgress" class="value">0%</div>
              </article>
              <article class="metric">
                <div class="label">æœ€å¾Œæ›´æ–°</div>
                <div id="lastUpdated" class="value">--:--:--</div>
              </article>
            </div>
            <div class="control-row">
              <button id="pauseAgent" class="ctrl-btn" type="button">æš«åœä»»å‹™</button>
              <button id="resumeAgent" class="ctrl-btn" type="button">æ¢å¾©ä»»å‹™</button>
              <button id="stopAgent" class="ctrl-btn stop" type="button">åœæ­¢ Agent</button>
              <button id="clearConsole" class="ctrl-btn" type="button">æ¸…é™¤ Console</button>
            </div>

            <article class="flow-card" aria-label="API è³‡æ–™æµ">
              <h3>API è³‡æ–™æµæ‹“æ¨¸ï¼ˆå¡ç‰‡å¼ï¼‰</h3>
              <p class="flow-help">ä»¥æ–¹å¡Šå¡ç‰‡å‘ˆç¾ç›®å‰å…ƒä»¶ï¼ˆUI / Gateway / AnythingLLM / Ollama / gpt-oss:20bï¼‰ï¼Œé€£ç·šæ—æ¨™ç¤ºé€šè¨Šæ–¹å¼ï¼ˆAPI / Local Runtimeï¼‰ã€‚</p>
              <svg id="flowSvg" class="flow-svg" viewBox="0 0 980 300" role="img" aria-label="UI åˆ° LLM çš„å¯¦éš›è³‡æ–™æµèˆ‡é€šè¨Šæ–¹å¼"></svg>
              <div class="flow-legend">
                <span class="chip">ğŸŸ¢ Active path</span>
                <span class="chip">ğŸŸ¡ Paused path</span>
                <span class="chip">ğŸ”¹ HTTP API / Webhook</span>
                <span class="chip">ğŸ§  Local runtime / provider call</span>
              </div>
            </article>
          </section>
          </section>
        </div>

        <section class="console-landscape" aria-label="console">
          <h2>Console</h2>
          <pre id="consoleLogLandscape" class="console-log">[system] ç­‰å¾…å•Ÿå‹•æŒ‡ä»¤...</pre>
        </section>
      </section>

      <section class="console" aria-label="console">
        <h2>Console</h2>
        <section id="consolePane" class="pane" role="region" aria-label="console">
            <pre id="consoleLog" class="console-log">[system] ç­‰å¾…å•Ÿå‹•æŒ‡ä»¤...</pre>
        </section>
      </section>
    </main>

    <script>
      const button = document.getElementById('startAgent');
      const status = document.getElementById('status');
      const assistantStatus = document.getElementById('assistantStatus');
      const executionStatus = document.getElementById('executionStatus');
      const taskProgress = document.getElementById('taskProgress');
      const lastUpdated = document.getElementById('lastUpdated');
      const consoleLog = document.getElementById('consoleLog');
      const consoleLogLandscape = document.getElementById('consoleLogLandscape');
      const pauseBtn = document.getElementById('pauseAgent');
      const resumeBtn = document.getElementById('resumeAgent');
      const stopBtn = document.getElementById('stopAgent');
      const clearConsoleBtn = document.getElementById('clearConsole');
      const flowSvg = document.getElementById('flowSvg');
      const photoInput = document.getElementById('photoInput');
      const motionToggle = document.getElementById('motionToggle');
      const pauseAndClearStageBtn = document.getElementById('pauseAndClearStage');
      const motionCanvas = document.getElementById('motionCanvas');
      const motionCtx = motionCanvas.getContext('2d');

      let runningMotion = true;
      let backgroundImage = null;

      const flowConfig = {
        nodes: [
          { id: 'ui', title: 'Dashboard UI', subtitle: 'approval_ui/index.html', x: 30, y: 105, w: 180, h: 78, kind: 'control' },
          { id: 'gateway', title: 'Gateway', subtitle: '/api/agent/control', x: 250, y: 105, w: 180, h: 78, kind: 'core' },
          { id: 'anythingllm', title: 'AnythingLLM', subtitle: 'Developer API /chat', x: 470, y: 105, w: 180, h: 78, kind: 'brain' },
          { id: 'ollama', title: 'Ollama', subtitle: 'Model Provider', x: 700, y: 40, w: 180, h: 78, kind: 'integration' },
          { id: 'gptoss', title: 'gpt-oss:20b (LLM)', subtitle: 'Inference Runtime', x: 700, y: 180, w: 180, h: 78, kind: 'integration' },
        ],
        edges: [
          { from: 'ui', to: 'gateway', label: 'HTTP API: GET/POST /api/agent/control' },
          { from: 'gateway', to: 'anythingllm', label: 'HTTP API: /api/v1/workspace/:id/chat' },
          { from: 'anythingllm', to: 'ollama', label: 'Provider API call' },
          { from: 'ollama', to: 'gptoss', label: 'Local model runtime' },
        ],
      };

      const basePose = {
        head: { x: 460, y: 160 },
        neck: { x: 460, y: 210 },
        shoulderL: { x: 415, y: 235 },
        shoulderR: { x: 505, y: 235 },
        elbowL: { x: 390, y: 300 },
        elbowR: { x: 540, y: 300 },
        handL: { x: 368, y: 360 },
        handR: { x: 580, y: 360 },
        hip: { x: 460, y: 365 },
        kneeL: { x: 430, y: 470 },
        kneeR: { x: 490, y: 470 },
        footL: { x: 410, y: 590 },
        footR: { x: 510, y: 590 },
      };

      const drawBone = (a, b, width = 5, color = '#38bdf8') => {
        motionCtx.beginPath();
        motionCtx.moveTo(a.x, a.y);
        motionCtx.lineTo(b.x, b.y);
        motionCtx.lineWidth = width;
        motionCtx.strokeStyle = color;
        motionCtx.stroke();
      };

      const drawJoint = (joint, color = '#e2e8f0') => {
        motionCtx.beginPath();
        motionCtx.arc(joint.x, joint.y, 5, 0, Math.PI * 2);
        motionCtx.fillStyle = color;
        motionCtx.fill();
      };

      const drawSkeleton = (pose) => {
        drawBone(pose.head, pose.neck, 3);
        drawBone(pose.neck, pose.shoulderL);
        drawBone(pose.neck, pose.shoulderR);
        drawBone(pose.shoulderL, pose.elbowL);
        drawBone(pose.elbowL, pose.handL);
        drawBone(pose.shoulderR, pose.elbowR);
        drawBone(pose.elbowR, pose.handR);
        drawBone(pose.neck, pose.hip, 6);
        drawBone(pose.hip, pose.kneeL);
        drawBone(pose.kneeL, pose.footL);
        drawBone(pose.hip, pose.kneeR);
        drawBone(pose.kneeR, pose.footR);
        Object.values(pose).forEach((joint) => drawJoint(joint));
      };

      const loadPhoto = (file) => new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = URL.createObjectURL(file);
      });

      photoInput.addEventListener('change', async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        try {
          backgroundImage = await loadPhoto(file);
          appendLog(`[stage] å·²è¼‰å…¥ç…§ç‰‡ï¼š${file.name}`);
        } catch (error) {
          appendLog(`[error] ç…§ç‰‡è¼‰å…¥å¤±æ•—ï¼š${error.message}`);
        }
      });

      motionToggle.addEventListener('click', () => {
        runningMotion = !runningMotion;
        motionToggle.textContent = runningMotion ? 'æš«åœå‹•ä½œ' : 'ç¹¼çºŒå‹•ä½œ';
        if (runningMotion) {
          requestAnimationFrame(renderMotion);
        }
      });

      const clearStageCanvas = () => {
        motionCtx.clearRect(0, 0, motionCanvas.width, motionCanvas.height);
        motionCtx.fillStyle = '#020617';
        motionCtx.fillRect(0, 0, motionCanvas.width, motionCanvas.height);
      };

      pauseAndClearStageBtn.addEventListener('click', () => {
        runningMotion = false;
        backgroundImage = null;
        motionToggle.textContent = 'ç¹¼çºŒå‹•ä½œ';
        clearStageCanvas();
        appendLog('[stage] å·²æš«åœå‹•ç•«ä¸¦æ¸…é™¤å·¦å´ç•«é¢');
      });

      const renderMotion = (timestamp) => {
        motionCtx.clearRect(0, 0, motionCanvas.width, motionCanvas.height);

        if (backgroundImage) {
          const ratio = Math.min(motionCanvas.width / backgroundImage.width, motionCanvas.height / backgroundImage.height);
          const drawWidth = backgroundImage.width * ratio;
          const drawHeight = backgroundImage.height * ratio;
          const x = (motionCanvas.width - drawWidth) / 2;
          const y = (motionCanvas.height - drawHeight) / 2;
          motionCtx.drawImage(backgroundImage, x, y, drawWidth, drawHeight);
        } else {
          motionCtx.fillStyle = '#0f172a';
          motionCtx.fillRect(0, 0, motionCanvas.width, motionCanvas.height);
          motionCtx.fillStyle = '#94a3b8';
          motionCtx.font = '600 20px "Noto Sans TC", sans-serif';
          motionCtx.fillText('ä¸Šå‚³ç…§ç‰‡å¾Œï¼Œå¯åœ¨å·¦å´çœ‹åˆ° 2D éª¨æ¶æ®æ‰‹æ¨¡æ“¬ã€‚', 170, 56);
        }

        const phase = timestamp * 0.004;
        const pose = structuredClone(basePose);
        pose.elbowR.y = basePose.elbowR.y - (Math.sin(phase) * 52);
        pose.handR.y = basePose.handR.y - (Math.sin(phase) * 88);
        pose.handR.x = basePose.handR.x + (Math.cos(phase) * 22);
        drawSkeleton(pose);

        if (runningMotion) {
          requestAnimationFrame(renderMotion);
        }
      };

      requestAnimationFrame(renderMotion);

      const toLocalTime = (iso) => {
        if (!iso) return '--:--:--';
        return new Date(iso).toLocaleTimeString('zh-Hant-TW', { hour12: false });
      };

      const appendLog = (text) => {
        [consoleLog, consoleLogLandscape].forEach((targetLog) => {
          targetLog.textContent += `\n${text}`;
          targetLog.scrollTop = targetLog.scrollHeight;
        });
      };

      const renderFlow = (controlState) => {
        if (!flowSvg) return;

        const nodeMap = new Map(flowConfig.nodes.map((node) => [node.id, node]));
        const isActive = controlState?.assistant_status === 'Running';
        const isPaused = controlState?.assistant_status === 'Paused';

        const edgeColor = isActive ? '#22d3ee' : (isPaused ? '#f59e0b' : '#64748b');

        const edgeMarkup = flowConfig.edges.map((edge) => {
          const from = nodeMap.get(edge.from);
          const to = nodeMap.get(edge.to);
          if (!from || !to) return '';

          const startX = from.x + from.w;
          const startY = from.y + (from.h / 2);
          const endX = to.x;
          const endY = to.y + (to.h / 2);
          const bendX = (startX + endX) / 2;
          const path = `M ${startX} ${startY} C ${bendX} ${startY}, ${bendX} ${endY}, ${endX} ${endY}`;

          const labelX = bendX;
          const labelY = ((startY + endY) / 2) - 8;

          return `
            <path d="${path}" fill="none" stroke="${edgeColor}" stroke-width="3" marker-end="url(#arrowhead)" opacity="0.9" />
            <rect x="${labelX - 130}" y="${labelY - 11}" width="260" height="18" rx="9" fill="rgba(15,23,42,0.95)" stroke="rgba(148,163,184,0.35)" />
            <text x="${labelX}" y="${labelY + 2}" fill="#cbd5e1" font-size="11" text-anchor="middle">${edge.label}</text>
          `;
        }).join('');

        const nodeMarkup = flowConfig.nodes.map((node) => {
          const fillByKind = {
            integration: '#0f172a',
            core: '#0b253a',
            control: '#1e1b4b',
            brain: '#032d39',
          };

          const activeNode = isActive && ['gateway', 'anythingllm', 'ollama', 'gptoss'].includes(node.id);
          const pausedNode = isPaused && ['gateway', 'anythingllm'].includes(node.id);
          const stroke = activeNode ? '#22d3ee' : (pausedNode ? '#f59e0b' : '#64748b');
          const titleX = node.x + 12;
          const titleY = node.y + 28;

          return `
            <g>
              <rect x="${node.x}" y="${node.y}" width="${node.w}" height="${node.h}" rx="12" fill="${fillByKind[node.kind] || '#0f172a'}" stroke="${stroke}" stroke-width="2.5" />
              <text x="${titleX}" y="${titleY}" fill="#e2e8f0" font-size="14" font-weight="700">${node.title}</text>
              <text x="${titleX}" y="${titleY + 20}" fill="#94a3b8" font-size="11">${node.subtitle}</text>
            </g>
          `;
        }).join('');

        flowSvg.innerHTML = `
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"></polygon>
            </marker>
          </defs>
          <g>
            ${edgeMarkup}
            ${nodeMarkup}
          </g>
        `;
      };

      const applyControlState = (data) => {
        assistantStatus.textContent = data.assistant_status;
        executionStatus.textContent = data.execution_status;
        taskProgress.textContent = `${data.task_progress}%`;
        lastUpdated.textContent = toLocalTime(data.last_updated_at);

        button.disabled = !data.can.start;
        pauseBtn.disabled = !data.can.pause;
        resumeBtn.disabled = !data.can.resume;
        stopBtn.disabled = !data.can.stop;
        renderFlow(data);
      };

      const refreshState = async () => {
        const response = await fetch('/api/agent/control');
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || 'è®€å– Agent ç‹€æ…‹å¤±æ•—');
        }
        applyControlState(payload.data);
      };

      const sendControl = async (action) => {
        const response = await fetch('/api/agent/control', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action }),
        });
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || `${action} å¤±æ•—`);
        }
        applyControlState(payload.data);
        return payload.data;
      };

      button.addEventListener('click', async () => {
        try {
          status.textContent = 'Agent å•Ÿå‹•ä¸­...';
          await sendControl('start');
          status.textContent = 'Agent å·²å•Ÿå‹•ï¼Œç§˜æ›¸å¾…å‘½ä¸­ã€‚';
          appendLog('[control] ä½¿ç”¨è€…å•Ÿå‹• Agent');
        } catch (error) {
          status.textContent = `å•Ÿå‹•å¤±æ•—ï¼š${error.message}`;
          appendLog(`[error] å•Ÿå‹•å¤±æ•—ï¼š${error.message}`);
        }
      });

      pauseBtn.addEventListener('click', async () => {
        try {
          await sendControl('pause');
          status.textContent = 'Agent å·²æš«åœã€‚';
          appendLog('[control] ä½¿ç”¨è€…æš«åœä»»å‹™');
        } catch (error) {
          status.textContent = `æš«åœå¤±æ•—ï¼š${error.message}`;
          appendLog(`[error] æš«åœå¤±æ•—ï¼š${error.message}`);
        }
      });

      resumeBtn.addEventListener('click', async () => {
        try {
          await sendControl('resume');
          status.textContent = 'Agent å·²æ¢å¾©åŸ·è¡Œã€‚';
          appendLog('[control] ä½¿ç”¨è€…æ¢å¾©ä»»å‹™');
        } catch (error) {
          status.textContent = `æ¢å¾©å¤±æ•—ï¼š${error.message}`;
          appendLog(`[error] æ¢å¾©å¤±æ•—ï¼š${error.message}`);
        }
      });

      stopBtn.addEventListener('click', async () => {
        try {
          await sendControl('stop');
          status.textContent = 'Agent å·²åœæ­¢ã€‚';
          appendLog('[control] ä½¿ç”¨è€…åœæ­¢ Agent');
        } catch (error) {
          status.textContent = `åœæ­¢å¤±æ•—ï¼š${error.message}`;
          appendLog(`[error] åœæ­¢å¤±æ•—ï¼š${error.message}`);
        }
      });

      clearConsoleBtn.addEventListener('click', () => {
        [consoleLog, consoleLogLandscape].forEach((targetLog) => {
          targetLog.textContent = '[system] console å·²æ¸…ç©º';
        });
        lastUpdated.textContent = toLocalTime(new Date().toISOString());
      });

      refreshState()
        .then(() => appendLog('[system] å·²é€£ç·š Gateway æ§åˆ¶ API'))
        .catch((error) => {
          status.textContent = `ç„¡æ³•é€£ç·šæ§åˆ¶ APIï¼š${error.message}`;
          appendLog(`[error] ç„¡æ³•é€£ç·šæ§åˆ¶ APIï¼š${error.message}`);
          renderFlow();
        });

      renderFlow();
    </script>
  </body>
</html>
